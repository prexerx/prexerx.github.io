<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><title>Terraform Azure Demo开源项目的官方文档 | 妖灵山</title><meta name="keywords" content="azure,terraform,cloud"><meta name="author" content="prexer"><meta name="copyright" content="prexer"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><meta name="description" content="这是开源项terraform-azure-demo的官方技术文档。">
<meta property="og:type" content="article">
<meta property="og:title" content="Terraform Azure Demo开源项目的官方文档">
<meta property="og:url" content="http://example.com/2020/11/03/terraform-azure-demo-doc/index.html">
<meta property="og:site_name" content="妖灵山">
<meta property="og:description" content="这是开源项terraform-azure-demo的官方技术文档。">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="http://example.com/images/blog-images/terraform_logo.png">
<meta property="article:published_time" content="2020-11-03T01:45:37.000Z">
<meta property="article:modified_time" content="2020-11-28T14:24:44.746Z">
<meta property="article:author" content="prexer">
<meta property="article:tag" content="azure">
<meta property="article:tag" content="terraform">
<meta property="article:tag" content="cloud">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://example.com/images/blog-images/terraform_logo.png"><link rel="shortcut icon" href="/img/favicon.png"><link rel="canonical" href="http://example.com/2020/11/03/terraform-azure-demo-doc/"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/node-snackbar/dist/snackbar.min.css"><script>var GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: {"path":"search.xml","languages":{"hits_empty":"找不到您查询的内容：${query}"}},
  translate: undefined,
  noticeOutdate: undefined,
  highlight: {"plugin":"highlighjs","highlightCopy":false,"highlightLang":false},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '天',
  date_suffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: {"limitCount":50,"languages":{"author":"作者: prexer","link":"链接: ","source":"来源: 妖灵山","info":"著作权归作者所有。商业转载请联系作者获得授权，非商业转载请注明出处。"}},
  ClickShowText: undefined,
  lightbox: 'fancybox',
  Snackbar: {"chs_to_cht":"你已切换为繁体","cht_to_chs":"你已切换为简体","day_to_night":"你已切换为深色模式","night_to_day":"你已切换为浅色模式","bgLight":"#49b1f5","bgDark":"#121212","position":"bottom-left"},
  source: {
    jQuery: 'https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js',
    justifiedGallery: {
      js: 'https://cdn.jsdelivr.net/npm/justifiedGallery/dist/js/jquery.justifiedGallery.min.js',
      css: 'https://cdn.jsdelivr.net/npm/justifiedGallery/dist/css/justifiedGallery.min.css'
    },
    fancybox: {
      js: 'https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js',
      css: 'https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.css'
    }
  },
  isPhotoFigcaption: true,
  islazyload: false,
  isanchor: false
};

var saveToLocal = {
  set: function setWithExpiry(key, value, ttl) {
    const now = new Date()
    const expiryDay = ttl * 86400000
    const item = {
      value: value,
      expiry: now.getTime() + expiryDay,
    }
    localStorage.setItem(key, JSON.stringify(item))
  },

  get: function getWithExpiry(key) {
    const itemStr = localStorage.getItem(key)

    if (!itemStr) {
      return undefined
    }
    const item = JSON.parse(itemStr)
    const now = new Date()

    if (now.getTime() > item.expiry) {
      localStorage.removeItem(key)
      return undefined
    }
    return item.value
  }
}

// https://stackoverflow.com/questions/16839698/jquery-getscript-alternative-in-native-javascript
const getScript = url => new Promise((resolve, reject) => {
  const script = document.createElement('script')
  script.src = url
  script.async = true
  script.onerror = reject
  script.onload = script.onreadystatechange = function() {
    const loadState = this.readyState
    if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
    script.onload = script.onreadystatechange = null
    resolve()
  }
  document.head.appendChild(script)
})</script><script id="config_change">var GLOBAL_CONFIG_SITE = { 
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2020-11-28 14:24:44'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(function () {  window.activateDarkMode = function () {
    document.documentElement.setAttribute('data-theme', 'dark')
    if (document.querySelector('meta[name="theme-color"]') !== null) {
      document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
    }
  }
  window.activateLightMode = function () {
    document.documentElement.setAttribute('data-theme', 'light')
   if (document.querySelector('meta[name="theme-color"]') !== null) {
      document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
    }
  }
  const autoChangeMode = '2'
  const t = saveToLocal.get('theme')
  if (autoChangeMode === '1') {
    const isDarkMode = window.matchMedia('(prefers-color-scheme: dark)').matches
    const isLightMode = window.matchMedia('(prefers-color-scheme: light)').matches
    const isNotSpecified = window.matchMedia('(prefers-color-scheme: no-preference)').matches
    const hasNoSupport = !isDarkMode && !isLightMode && !isNotSpecified
    if (t === undefined) {
      if (isLightMode) activateLightMode()
      else if (isDarkMode) activateDarkMode()
      else if (isNotSpecified || hasNoSupport) {
        const now = new Date()
        const hour = now.getHours()
        const isNight = hour <= 6 || hour >= 18
        isNight ? activateDarkMode() : activateLightMode()
      }
      window.matchMedia('(prefers-color-scheme: dark)').addListener(function (e) {
        if (saveToLocal.get('theme') === undefined) {
          e.matches ? activateDarkMode() : activateLightMode()
        }
      })
    } else if (t === 'light') activateLightMode()
    else activateDarkMode()
  } else if (autoChangeMode === '2') {
    const now = new Date()
    const hour = now.getHours()
    const isNight = hour <= 6 || hour >= 18
    if (t === undefined) isNight ? activateDarkMode() : activateLightMode()
    else if (t === 'light') activateLightMode()
    else activateDarkMode()
  } else {
    if (t === 'dark') activateDarkMode()
    else if (t === 'light') activateLightMode()
  }const asideStatus = saveToLocal.get('aside-status')
if (asideStatus !== undefined) {
   if (asideStatus === 'hide') {
     document.documentElement.classList.add('hide-aside')
   } else {
     document.documentElement.classList.remove('hide-aside')
   }
}})()</script><meta name="generator" content="Hexo 5.2.0"></head><body><div id="loading-box"><div class="loading-left-bg"></div><div class="loading-right-bg"></div><div class="spinner-box"><div class="configure-border-1"><div class="configure-core"></div></div><div class="configure-border-2"><div class="configure-core"></div></div><div class="loading-word">加载中...</div></div></div><div id="web_bg"></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="author-avatar"><img class="avatar-img" src="/images/site/header.jpg" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="site-data"><div class="data-item is-center"><div class="data-item-link"><a href="/archives/"><div class="headline">文章</div><div class="length-num">5</div></a></div></div><div class="data-item is-center"><div class="data-item-link"><a href="/tags/"><div class="headline">标签</div><div class="length-num">15</div></a></div></div><div class="data-item is-center"><div class="data-item-link"><a href="/categories/"><div class="headline">分类</div><div class="length-num">7</div></a></div></div></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 时间轴</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> 友链</span></a></div><div class="menus_item"><a class="site-page" href="/talktalk/"><i class="fa-fw fas fa-comment-dots"></i><span> 留言板</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于</span></a></div></div></div></div><div id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url(/images/site/index_home_top.jpg)"><nav id="nav"><span id="blog_name"><a id="site-name" href="/">妖灵山</a></span><div id="menus"><div id="search-button"><a class="site-page social-icon search"><i class="fas fa-search fa-fw"></i><span> 搜索</span></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 时间轴</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> 友链</span></a></div><div class="menus_item"><a class="site-page" href="/talktalk/"><i class="fa-fw fas fa-comment-dots"></i><span> 留言板</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于</span></a></div></div><div id="toggle-menu"><a class="site-page"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">Terraform Azure Demo开源项目的官方文档</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2020-11-03T01:45:37.000Z" title="发表于 2020-11-03 01:45:37">2020-11-03</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2020-11-28T14:24:44.746Z" title="更新于 2020-11-28 14:24:44">2020-11-28</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/terraform/">terraform</a><i class="fas fa-angle-right post-meta-separator"></i><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/terraform/azure-cloud/">azure-cloud</a></span></div><div class="meta-secondline"> <span class="post-meta-separator">|</span><span class="post-meta-wordcount"><i class="far fa-file-word fa-fw post-meta-icon"></i><span class="post-meta-label">字数总计:</span><span class="word-count">8.6k</span><span class="post-meta-separator">|</span><i class="far fa-clock fa-fw post-meta-icon"></i><span class="post-meta-label">阅读时长:</span><span>32分钟</span></span><span class="post-meta-separator">|</span><span class="post-meta-pv-cv"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">阅读量:</span><span id="busuanzi_value_page_pv"></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><div class="note light flat"><p>这是开源项terraform-azure-demo的官方技术文档。</p>
</div>

<a id="more"></a>

<p>开门见山，阅读本文后，你将学会如何使用terraform工具配合HCL语言完成AzureCloud资源配置和构建。</p>
<p>如果你还不了解如何在项目中真正的使用Azure云，那就耐心的读下去吧，这里浓缩了一个实际项目的方方面面。</p>
<p>项目传送门 &gt; <a target="_blank" rel="noopener" href="https://github.com/prexerx/terraform-azure-demo">terraform-azure-demo</a></p>
<p>你既然已经找到了这里，肯定是有需求或者想要学习在AzureCloud上自动构建资源的技术，那么我们先来看看这个项目简介和概览。</p>
<h2 id="项目简介"><a href="#项目简介" class="headerlink" title="项目简介"></a>项目简介</h2><p><code>terraform</code>是由<code>Hashicorp</code>公司开源出来的，用于云服务资源部署、规划和管理的工具集。它理论上可以服务于任何云服务商，包括你所知道的云服务几大巨头，如：微软云（AzureCloud），亚马逊（AWS）等。</p>
<p>本项目主要基于AzureCloud，使用terraform工具来规划和管理AzureCloud上的资源，并构建可用的实用案例。</p>
<p>该项目真实有效，你几乎只需要修改一小部分，就可以应用到项目中。</p>
<h2 id="项目概览"><a href="#项目概览" class="headerlink" title="项目概览"></a>项目概览</h2><p>要想尽快的熟悉一个项目，做一个整体的把握是必不可少的，文档的说明就是这个作用，不管是什么样的开源项目，只要它开源出来肯定是希望大家一起能够学习并充实它，让它更富有生命力。</p>
<p>本项目是一个简单的开源项目，只是一个笔者在工作中浓缩的经验集合，看起来短小的它其实很精悍，毫不夸张的说，如果你完全明白该项目的所有细节，开发一个实际项目是没有什么问题的。</p>
<p>书归正传，为了让大家有一个更好的理解，笔者打算用框图来表示一个项目的概况，配合着一些简单的讲解，更有助于你快速掌握。</p>
<p><a target="_blank" rel="noopener" href="https://www.processon.com/view/link/5fa0bc996376891d320614ef">项目概览图</a></p>
<p>基本上所有的内容都有在图上标注，这里强调一些重要概念，可以让你更清楚我们的意图：</p>
<ul>
<li><code>顶层模块</code>（Top-Level）是真实的用户可配置的交互模块，但任然可以被用于其他模块的子模块（submodule）</li>
<li>模块的定义就和你熟悉的函数一样，它具有输入（input variable）和输出（output）</li>
<li>模块的参数传递都是经过<code>Input variable</code>来完成的，并且和函数式编程类似，它们支持默认值，也支持覆写</li>
<li>模块的输出都是通过<code>Output</code>来完成的，其他的模块组件内容，对外都不可见</li>
<li>terraform默认支持远程模块的能力，这就表示我们可以很轻易的使用类似<code>github</code>等远程代码托管仓库中的代码，复用更方便</li>
<li>terrform配置文件扩展名为<code>.tf</code>，它还有一些其他的文件定义形式，当然也会有不同的作用，项目中使用的<code>*.auto.tfvars</code>就是其中一种，它的作用是覆写顶层模块的参数，其他格式请自行查询terrform的官方文档</li>
<li>terraform定义模块是和目录结构有关的，一个模块基本上都在同一个目录层级，使用构建指令的时候，并不会在没有引用子模块的时候递归查询子目录</li>
</ul>
<p>项目仓库目录树：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">prexer $ tree</span><br><span class="line">.</span><br><span class="line">├── backend.tf</span><br><span class="line">├── configs</span><br><span class="line">│   └── hibro-azure.tmpl.yml</span><br><span class="line">├── default.auto.tfvars</span><br><span class="line">├── demo-steps</span><br><span class="line">│   ├── demo.session</span><br><span class="line">│   └── timing.steps</span><br><span class="line">├── LICENSE</span><br><span class="line">├── main.tf</span><br><span class="line">├── Makefile</span><br><span class="line">├── modules</span><br><span class="line">│   ├── moduleDisk</span><br><span class="line">│   │   ├── main.tf</span><br><span class="line">│   │   ├── outputs.tf</span><br><span class="line">│   │   ├── README.md</span><br><span class="line">│   │   └── variables.tf</span><br><span class="line">│   └── moduleNet</span><br><span class="line">│       ├── main.tf</span><br><span class="line">│       ├── outputs.tf</span><br><span class="line">│       ├── README.md</span><br><span class="line">│       └── variables.tf</span><br><span class="line">├── outputs.tf</span><br><span class="line">├── README.md</span><br><span class="line">├── statefile</span><br><span class="line">└── variables.tf</span><br><span class="line"></span><br><span class="line">6 directories, 19 files</span><br></pre></td></tr></table></figure>



<h2 id="当前复现环境"><a href="#当前复现环境" class="headerlink" title="当前复现环境"></a>当前复现环境</h2><p>截止到现在，这个项目是有效的，后续随着Azure和Terraform项目进行迭代，也许会存在版本兼容的问题，不过在可见的未来，应该大体不会变化。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">prexer $ terraform --version</span><br><span class="line">Terraform v0.13.5</span><br><span class="line">+ provider registry.terraform.io&#x2F;hashicorp&#x2F;azurerm v2.34.0</span><br><span class="line">+ provider registry.terraform.io&#x2F;hashicorp&#x2F;null v3.0.0</span><br><span class="line">+ provider registry.terraform.io&#x2F;hashicorp&#x2F;random v3.0.0</span><br><span class="line">+ provider registry.terraform.io&#x2F;hashicorp&#x2F;template v2.2.0</span><br><span class="line"></span><br><span class="line">prexer $ cat &#x2F;proc&#x2F;version</span><br><span class="line">Linux version 4.15.0-1098-azure (buildd@lcy01-amd64-022) (gcc version 5.4.0 20160609 (Ubuntu 5.4.0-6ubuntu1~16.04.12)) #109~16.04.1-Ubuntu SMP Wed Sep 30 18:53:14 UTC 2020</span><br><span class="line"></span><br><span class="line">prexer $ az version</span><br><span class="line">&#123;</span><br><span class="line">  &quot;azure-cli&quot;: &quot;2.14.0&quot;,</span><br><span class="line">  &quot;azure-cli-core&quot;: &quot;2.14.0&quot;,</span><br><span class="line">  &quot;azure-cli-telemetry&quot;: &quot;1.0.6&quot;,</span><br><span class="line">  &quot;extensions&quot;: &#123;</span><br><span class="line">    &quot;ai-examples&quot;: &quot;0.2.4&quot;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h2 id="快速上手尝鲜"><a href="#快速上手尝鲜" class="headerlink" title="快速上手尝鲜"></a>快速上手尝鲜</h2><p>如果想要使用这个Demo项目，你最少应该进行如下步骤：</p>
<ol>
<li>注册一个Azure云账号，可以自己建立或者通过公司的管理者进行开通</li>
<li>让你的账户所属一个可控的订阅中，一般都是公司或其他组着管控</li>
<li>获得适当的权限，至少拥有可以创建一定范围内资源的权限</li>
<li>最后，就是熟悉如何使用Azure门户和Bash Shell</li>
</ol>
<p>不过，不管怎么样，微软云都提供了一个免费体验的服务，你可以在微软进行认证后，获得<code>200美金</code>为期<code>一个月</code>的使用权，用来做前期的设计和实践已经足够了。</p>
<p>然后，登录Azure打开Cloud Bash Shell，然后运行（这是一整个资源的生命周期，按照自己的需求使用相应的指令）</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 1. 创建一个临时目录</span></span><br><span class="line">mkdir demo &amp;&amp; cd $_</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 2. 克隆demo示例，并跳转工作目录</span></span><br><span class="line">git clone https://github.com/prexerx/terraform-azure-demo.git &amp;&amp; cd terraform-azure-demo</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 3. 初始化terraform转态文件和一些脚本插件资源</span></span><br><span class="line">make init # or terraform init</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 4. 制定计划，一定要仔细看</span></span><br><span class="line">make plan t=demo</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 5. 应用计划，跟踪输出</span></span><br><span class="line">make apply t=demo</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 6. 制定删除计划，请仔细查看每一个细节，避免造成不可恢复的损失</span></span><br><span class="line">make dplan t=demo</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 7. 慎重执行删除操作，除非你知道自己在做什么，否则不要使用</span></span><br><span class="line">make dapply t=demo</span><br></pre></td></tr></table></figure>



<p>如果你没有功夫注册微软云服务，那你可以通过笔者的示例演示，来回放我在云端操作的细节，复现步骤就是简单的运行：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> [from] script -t 2&gt; timing.steps -a demo.session</span></span><br><span class="line">scriptreplay demo-steps/timing.steps demo-steps/demo.session</span><br></pre></td></tr></table></figure>

<p>它会给你展示一个完整的终端交互过程，和你在云端的操作如出一辙。</p>
<h2 id="快速获取技术帮助"><a href="#快速获取技术帮助" class="headerlink" title="快速获取技术帮助"></a>快速获取技术帮助</h2><p>基本上如果你有一定的编程经验，那完全可以自给自足的完成本Demo的自主构建。</p>
<p>在寻求帮助的时候，搜索引擎是必不可少的，使用起来你应该已经得心应手了，就像这样：</p>
<p>如果你不懂<code>resource &quot;azurerm_resource_group&quot;</code>，那么通过搜索引擎来按照关键字查询，如：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&gt; resource &quot;azurerm_resource_group&quot; site:terraform.io</span><br><span class="line"># or</span><br><span class="line">&gt; terraform resource &quot;azurerm_resource_group&quot;</span><br></pre></td></tr></table></figure>

<p>详细的定向技术文档会马上呈现在你的面前，你只需要挑选你需要的部分，细心研读即可。</p>
<h2 id="项目实现细节"><a href="#项目实现细节" class="headerlink" title="项目实现细节"></a>项目实现细节</h2><p>整体把握后，我们来看看具体的实现细节。</p>
<p>由于我们是基于AzureCloud来配置资源，导致文中不可避免的会多一些AzureCloud的相关说明，不过本着<code>够用即最好</code>的原则，要想使用本项目，只需要了解本文讲解的内容即可。</p>
<p>为了更好的理解项目内容，模块的划分和文件重心也经过精心的设计，后续实现的说明我们按照指定文件来一步步说明。</p>
<p>由于terraform是基于<code>HCL语言</code>来进行解释资源的，所以你可以先看看官方的<a target="_blank" rel="noopener" href="https://github.com/hashicorp/hcl">语法支持</a>，了解一个大概，基本上这个语言是很好理解的，都是关键字和语句块组成，并配合着命名空间来实现资源的抽象和划分。</p>
<p>好了，开始看看源码的细节吧！</p>
<h3 id="backend-tf"><a href="#backend-tf" class="headerlink" title="backend.tf"></a>backend.tf</h3><p><code>backend.tf</code>文件是给<code>terraform</code>工具<code>本身</code>添加自定义配置项的。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">terraform &#123;</span><br><span class="line">  required_providers &#123;</span><br><span class="line">    azurerm &#x3D; &#123;</span><br><span class="line">      source &#x3D; &quot;hashicorp&#x2F;azurerm&quot;</span><br><span class="line">      version &#x3D; &quot;&gt;&#x3D; 2.26&quot;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">provider &quot;azurerm&quot; &#123;</span><br><span class="line">  features &#123;&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这里告诉terraform，我们的后端打算用AzureCloud，在terraform规划的资源管理方面，AzureCloud名称为<code>azurerm</code>也就是<code>Azure Resource Management</code>，并定义了工具的版本参数，它会影响工具的插件集合，所以最好指定一个高阶版本；至于<code>features</code>是AzureCloud等运营商特定的内容，基本上实践项目也没有特别的指定，但又必须实现这个块来使用默认值，所以放在这里也无伤大雅。</p>
<p>接着迎来了重头戏：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"># for Azure backend, you can store your statefile on Azure Cloud.</span><br><span class="line"></span><br><span class="line"># terraform &#123;</span><br><span class="line">#   backend &quot;azurerm&quot; &#123;</span><br><span class="line">#     resource_group_name  &#x3D; &quot;Azure resource group name&quot;</span><br><span class="line">#     storage_account_name &#x3D; &quot;Storage Account in your resource group&quot;</span><br><span class="line">#     container_name       &#x3D; &quot;You should generate a container in your Storage Account, such as: terraform-state&quot;</span><br><span class="line">#     key                  &#x3D; &quot;Terraform Statfile Name, such as: name.terraform.tfstate&quot;</span><br><span class="line">#     access_key           &#x3D; &quot;Storage Account Access Key, you can get it from Azure portal.&quot;</span><br><span class="line">#   &#125;</span><br><span class="line"># &#125;</span><br><span class="line"></span><br><span class="line"># for reference from other resources.</span><br><span class="line"></span><br><span class="line"># data &quot;terraform_remote_state&quot; &quot;hibro&quot; &#123;</span><br><span class="line">#   backend &#x3D; &quot;azurerm&quot;</span><br><span class="line"></span><br><span class="line">#   config &#x3D; &#123;</span><br><span class="line">#     storage_account_name &#x3D; &quot;same as backend azurerm block&quot;</span><br><span class="line">#     container_name       &#x3D; &quot;same as backend azurerm block&quot;</span><br><span class="line">#     key                  &#x3D; &quot;same as backend azurerm block&quot;</span><br><span class="line">#     access_key           &#x3D; &quot;same as backend azurerm block&quot;</span><br><span class="line">#   &#125;</span><br><span class="line"># &#125;</span><br><span class="line"></span><br><span class="line"># Just to teach you with local backend.</span><br><span class="line">terraform &#123;</span><br><span class="line">  backend &quot;local&quot; &#123;</span><br><span class="line">    path &#x3D; &quot;statefile&#x2F;hibro.terraform.tfstate&quot;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"># for refer local statefile.</span><br><span class="line"></span><br><span class="line"># data &quot;terraform_remote_state&quot; &quot;hibro_state&quot; &#123;</span><br><span class="line">#   backend &#x3D; &quot;local&quot;</span><br><span class="line"></span><br><span class="line">#   config &#x3D; &#123;</span><br><span class="line">#     path &#x3D; &quot;$&#123;path.module&#125;&#x2F;statefile&#x2F;hibro.terraform.tfstate&quot;</span><br><span class="line">#   &#125;</span><br><span class="line"># &#125;</span><br></pre></td></tr></table></figure>

<p>关于<code>terraform.backend</code>技术块，它是用来说明terraform的<code>状态文件</code>（名称类似<code>*.terraform.tfstate</code>）将要存储在哪里，也就是说在执行<code>terraform init</code>和<code>terraform apply</code>指令的时候，前者会找到存储位置然后进行后续资源的判定，而后者也是由于前面资源的判定，进而决定哪些资源需要创建、修改或者删除等操作。</p>
<p>后端存储基本分为两种：</p>
<ol>
<li>本地存储，这也是默认行为，如果你不配置它会存储在你本地的当前工作目录</li>
<li>远程存储，你可以根据需求存储terraform状态文件到远程位置，如：微软的存储账户，或者github等地方。</li>
</ol>
<p>我们为了方便演示，将状态文件存储在本地指定的目录位置：<code>statefile/</code>(相对目录)，并且命名为<code>hibro.terraform.tfstate</code></p>
<p>存储在远程的位置也是很简单的，如图所示，获取远程资源后，一次填写配置即可：（我们假设你已经构建了一个存储账户）</p>
<p><img src="/img/blog-images/azure_terraform_backend.png" alt="Azure上获得配置"></p>
<p>至于<code>container_name</code>需要在Azure上创建一个，当然Azure提供了<code>az</code>指令可以完成这个工作，不过我们演示下从web界面操作的方法：</p>
<p><img src="/img/blog-images/azure_storage_container_create.png" alt="在存储账户上创建容器"></p>
<p>至于剩下的<code>data.terraform_remote_state</code>块，是作引用你存储过的状态文件之用；也就是说在引用之前，你的文件一定是存在的，当然它也对应着远程和本地位置，如果状态文件不存在，terraform会报错提示你找不到相应的状态文件。</p>
<p>对于<code>backend = &quot;azurerm&quot;/&quot;local&quot;</code>引用块来说，这部分说明你要引用的后端位置，其他的配置基本上和前文配置的存储位置一致。</p>
<p>你也不用诧异，很多时候，这个状态文件是作为terraform的枢纽一样的存在，它可以帮助你存贮资源的概况，甚至作为其他资源的输入部分，只要引用它，就可以得到它的所有输出。</p>
<h3 id="default-auto-tfvars"><a href="#default-auto-tfvars" class="headerlink" title="default.auto.tfvars"></a>default.auto.tfvars</h3><p>前文已经提到，terraform支持很多扩展文件名，如<code>.tf</code>,<code>.auto.tfvars</code>等，其他格式去terraform官网看看吧，这里就不展开介绍了。</p>
<p>对于本项目中的<code>default.auto.tfvars</code>文件来说，它的作用是覆写默认的顶层模块配置参数值。</p>
<p>首先你必须知道，在default.auto.tfvars文件中配置的值，一定要在<code>variable.tf</code>文件中也定义，否则你去覆写谁呢？而且按照前文的描述，模块的输入都是通过<code>input variable</code>来完成的，对应的部分就是<code>variable.tf</code>文件中的内容。</p>
<p>这里再说明下，一个模块（限定一个模块）的所有资源都可以写到一个文件中，就算写到不同的<code>tf文件</code>中，最后terraform也会整合到一起；terraform的做法是，解析当前模块目录中的所有<code>tf文件</code>，并不递归解析；不过对于复杂的项目来说，根据文件来区分重要的部分，可以更清晰的了解项目细节，而且这也是terraform官方推荐的做法。</p>
<p>文件中的内容如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">prefix   &#x3D; &quot;hibro&quot;</span><br><span class="line">location &#x3D; &quot;westus2&quot;</span><br><span class="line"></span><br><span class="line">os_publisher &#x3D; &quot;kinvolk&quot;</span><br><span class="line">os_offer     &#x3D; &quot;flatcar-container-linux-free&quot;</span><br><span class="line">os_sku       &#x3D; &quot;stable&quot;</span><br><span class="line">os_version   &#x3D; &quot;latest&quot;</span><br><span class="line"></span><br><span class="line">admin_username &#x3D; &quot;core&quot;</span><br><span class="line">admin_password &#x3D; &quot;disable for flatcar OS&quot;</span><br><span class="line">admin_pub_key  &#x3D; &quot;ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQCorWm8FA4ovqbqWGQgoQ2QJo+CuFK7Dr8Zujen6iQVCWaWx&#x2F;2oCGOi4sgpwAt9H5zfXFBag7eXrG9lL4DE3W5GONmcdn4v8fA0AASORu++mUfLBN3YjcQAudRQLlOtVYVaHTRbL2jiXBHuNvZjkrH1EyCKPdAZEPWauGOE4CXtE&#x2F;e0Qlcb9i&#x2F;rK7Eqm3b7&#x2F;BzbUiNUJv1XpLFuJFSR5YugnSzBxkghvsyz4oOsbJ65pwPgwCGI1gsECcQ3WN93REwekOOedIONRlEzbp6KCCWWAf9rFD4E++INQAvmB+Js8X1WxWydeq3NWHMmFNDLRqAuUnyvsVzVwwBSdlNPJVzb&quot;</span><br></pre></td></tr></table></figure>

<p>这和你们接触过的，如<code>定义变量</code>，出奇的一致，不是么？只不过terraform支持的类型基本和python或者json类似，这里也不过多说明，后续我们会用到字符串、布尔变量、列表、字典和对象等类型。</p>
<h3 id="variable-tf（顶层输入）"><a href="#variable-tf（顶层输入）" class="headerlink" title="variable.tf（顶层输入）"></a>variable.tf（顶层输入）</h3><p>这里我们就顶层模块的输入部分来说明，它的官方说法是<code>input variable</code>，不过本文对于<code>input variable</code>和<code>variable</code>并不区分。</p>
<p>由于篇幅限制，我们只讲解重点说明的部分，截取部分代码，后续也是如此，如果要看详细配置，请自行克隆项目源码，它并不多，不是么？</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line">variable &quot;admin_username&quot; &#123;</span><br><span class="line">    type &#x3D; string</span><br><span class="line">    description &#x3D; &quot;Administrator user name for virtual machine&quot;</span><br><span class="line">    default &#x3D; &quot;hibro&quot;</span><br><span class="line">&#125;</span><br><span class="line">...</span><br><span class="line">## a map for tags</span><br><span class="line">variable &quot;tags&quot; &#123;</span><br><span class="line">    type &#x3D; map</span><br><span class="line">    default &#x3D; &#123;</span><br><span class="line">        hibroTags &#x3D; &quot;Terraform Demo with Tags&quot;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<p>这里仅仅列举两种变量类型，字符串和字典，当然布尔值、列表和其他类型也很简单，自行查询文档就可以了。</p>
<p>对于<code>variable.xxx</code>块来说，后面的<code>xxx</code>部分就是变量的名字，也是别人引用的变量名称，不过这里有一点需要注意，以往的引用都是一个完整的命名空间前缀，如：<code>data.terraform.backend</code>这样，而对于变量的引用却有些不同，应该使用<code>var.xxx</code>来完成。</p>
<blockquote>
<p> type &lt; 变量中可以存在类型的强定义，如果没有定义那么terraform会自行推导。</p>
</blockquote>
<blockquote>
<p>description &lt; 变量的解释说明，由于这是一门DSL，所以它的解释说明对于一个资源来说是有需要的，但不是必要的</p>
</blockquote>
<blockquote>
<p>default &lt; 变量的默认值，如果没有传入变量值，则会使用默认值，如果没有默认值又没有传入变量，则会报错</p>
</blockquote>
<blockquote>
<p><code>type = map</code>定义一个字典变量，就是你理解的键值对，并没有什么特别，嵌套和对象的引用和你熟悉的语言类似</p>
</blockquote>
<h3 id="main-tf-顶层主要配置"><a href="#main-tf-顶层主要配置" class="headerlink" title="main.tf(顶层主要配置)"></a>main.tf(顶层主要配置)</h3><p>这部分当之无愧是重头戏，所有资源的布局和调配基本都起源于它；那么我们需要完全的引用它的内容，并在代码中以详细的注释来说明它的用法：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"># Create a Top Level Resource Group 怎么看都是注释，不是么？</span><br><span class="line"># 定义一个资源组，名称为&quot;rg&quot;,引用名称为&#39;azurerm_resource_group.rg&#39;</span><br><span class="line"># 这里和常用的命名空间也有所不同，不用带有&#39;resource&#39;关键字</span><br><span class="line">resource &quot;azurerm_resource_group&quot; &quot;rg&quot; &#123; </span><br><span class="line">  name     &#x3D; &quot;$&#123;var.prefix&#125;-RG&quot; # 资源组的名字</span><br><span class="line">  # 资源组所在位置，也就是说你的资源组应该建立在哪里，如美国西部（westus）或者欧洲（europe）等</span><br><span class="line">  # 同样的，它会关联你的其他资源，他们需要放在一起，跨域很多时候是不行的！</span><br><span class="line">  location &#x3D; var.location </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"># Generate random text for a unique storage account name</span><br><span class="line"># terraform内置的资源，可以帮忙随机产生一个随机8位ID，用于后续的存贮账户命名</span><br><span class="line">resource &quot;random_id&quot; &quot;randomId&quot; &#123;</span><br><span class="line">    keepers &#x3D; &#123; # 持有者为前文定义的资源组</span><br><span class="line">        resource_group &#x3D; azurerm_resource_group.rg.name</span><br><span class="line">    &#125;</span><br><span class="line">    # 随机字符数目</span><br><span class="line">    byte_length &#x3D; 8</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"># Create storage account for boot diagnostics</span><br><span class="line"># 创建一个存储账户，名称为sa</span><br><span class="line">resource &quot;azurerm_storage_account&quot; &quot;sa&quot; &#123;</span><br><span class="line">	# 存储账户的名字，它必须是AzureCloud上唯一的，所以使用了一个字符串拼接的技巧，并且内部扩展了变量，引用了之前生成的随机ID</span><br><span class="line">    name                        &#x3D; &quot;hibro$&#123;random_id.randomId.hex&#125;&quot;</span><br><span class="line">    # 所属资源组，后续不再说明</span><br><span class="line">    resource_group_name         &#x3D; azurerm_resource_group.rg.name</span><br><span class="line">    # 资源所处位置，后续不再说明</span><br><span class="line">    location                    &#x3D; var.location</span><br><span class="line">    # 存储账户的天梯榜，也就是性能，分为：Standard and Premium</span><br><span class="line">    account_tier                &#x3D; &quot;Standard&quot;</span><br><span class="line">    # 定义用于此存储帐户的复制类型，也是默认值</span><br><span class="line">    account_replication_type    &#x3D; &quot;LRS&quot;</span><br><span class="line">	# 自定义的资源标签，用于处理对象关系，这里的类型是一个字典</span><br><span class="line">    tags &#x3D; &#123;</span><br><span class="line">        uAwesomeAccount &#x3D; &quot;hibro-Account&quot;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"># 引用一个submodule，注意，这不是定义，而是引用模块的写法</span><br><span class="line">module &quot;hibroNet&quot; &#123; # 引用模块后，在本模块中定义了一个别名，为&#96;module.hibroNet&#96;</span><br><span class="line">  # 引用外部子模块的语法，这是引用本地模块的语法，解析了相对于当前模块位置的其他模块，如 moduleNet</span><br><span class="line">  source &#x3D; &quot;.&#x2F;modules&#x2F;moduleNet&quot; </span><br><span class="line"></span><br><span class="line">  # 模块变量的参数传递，有时候我们会根据自己的需要修改引用模块的参数，这里就是一个方案</span><br><span class="line">  # 需要注意的是，这里的参数定义和引用模块的参数定义是对应的，子模块必须定义这些变量才行！</span><br><span class="line">  prefix &#x3D; var.prefix # 一个项目特定的前缀，后文都是一样的&#96;hibro-&#96;</span><br><span class="line">  location &#x3D; azurerm_resource_group.rg.location</span><br><span class="line">  resource_group &#x3D; azurerm_resource_group.rg.name</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">module &quot;hibroDisk&quot; &#123;</span><br><span class="line">  source &#x3D; &quot;.&#x2F;modules&#x2F;moduleDisk&quot; # 引用本地子模块moduleDisk</span><br><span class="line"></span><br><span class="line">  prefix &#x3D; var.prefix</span><br><span class="line">  location &#x3D; azurerm_resource_group.rg.location</span><br><span class="line">  resource_group &#x3D; azurerm_resource_group.rg.name</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">module &quot;hibroRemote&quot; &#123;</span><br><span class="line">  # 引用远程子模块，它位于github上，在terraform init的时候会导入它到本地，本质上和本地差不多。</span><br><span class="line">  # 语法形式为官方提供，只需要按照标准书写即可</span><br><span class="line">  source &#x3D; &quot;git::https:&#x2F;&#x2F;github.com&#x2F;prexerx&#x2F;terraform-remote-module.git&quot;</span><br><span class="line"></span><br><span class="line">  prefix &#x3D; var.prefix</span><br><span class="line">  location &#x3D; azurerm_resource_group.rg.location</span><br><span class="line">  resource_group &#x3D; azurerm_resource_group.rg.name</span><br><span class="line">  # 这里的技巧和其他的不同，这里使用了前文的&#96;module.hibroNet&#96;模块的输出，并用它的ID来作为远程模块的输入</span><br><span class="line">  # 默认的，它也就说明了一种依赖关系，说明远程模块(hibroRemote)资源的构建需要依赖本地模块(hibroNet)的资源，先后顺序一目了然</span><br><span class="line">  subnet_id &#x3D; module.hibroNet.subnet_id # 这也是一种对象类型</span><br><span class="line"></span><br><span class="line">  depends_on &#x3D; [ # 如果没有显示的资源依赖关系定义，那么就需要使用这个关键字段来说明，这是一个列表对象，用逗号分隔所依赖的资源</span><br><span class="line">    azurerm_resource_group.rg</span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"># Create a Linux virtual machine</span><br><span class="line"># 创建一个虚拟机，有很多的官方资源关键字可以使用，不过我们就以&#96;azurerm_virtual_machine&#96;说明，其他都类似</span><br><span class="line">resource &quot;azurerm_virtual_machine&quot; &quot;vm&quot; &#123; # 虚拟机资源定义别名</span><br><span class="line">  name                  &#x3D; &quot;hibro-VM&quot; # 虚拟机资源的名字</span><br><span class="line">  location              &#x3D; azurerm_resource_group.rg.location</span><br><span class="line">  resource_group_name   &#x3D; azurerm_resource_group.rg.name</span><br><span class="line">  network_interface_ids &#x3D; [module.hibroRemote.nic_id] # 附着在虚拟机上的网卡列表，一台机器多个网卡很常见不是么？</span><br><span class="line">  primary_network_interface_id &#x3D; module.hibroRemote.nic_id # 主网卡标记</span><br><span class="line"></span><br><span class="line">  vm_size               &#x3D; var.vm_size # 这很重要，表示你使用了一个什么性能虚拟机，它包括类似CPU，内存，缓存等相关的资源，计费也是比较可观的，所以请根据自己的需求，查看官方文档后来选择</span><br><span class="line"></span><br><span class="line">  # 当删除虚拟机的时候也删除系统盘</span><br><span class="line">  delete_os_disk_on_termination &#x3D; true</span><br><span class="line"></span><br><span class="line">  boot_diagnostics &#123; # 调试块，还有很多参数，不过我们只关心虚拟机开机启动的调试log</span><br><span class="line">    enabled     &#x3D; var.debug_enable # 使能调试</span><br><span class="line">    # 指定log的存储位置，这里存储在我们前文创建的存储账户中了，所有的开机log都在那里！</span><br><span class="line">    storage_uri &#x3D; azurerm_storage_account.sa.primary_blob_endpoint</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  storage_os_disk &#123; # 构建虚拟机操作系统镜像的磁盘</span><br><span class="line">    name              &#x3D; &quot;$&#123;var.prefix&#125;-OsDisk&quot; # 系统盘的名字</span><br><span class="line">    caching           &#x3D; &quot;ReadWrite&quot; # 缓存形式，这些概念需要你有一些操作系统方面的知识</span><br><span class="line">    create_option     &#x3D; &quot;FromImage&quot; # 从ISO创建，就这样，目前Flatcar也通常是使用这种方法来配置的，AzureCloud会帮你拉取ISO镜像</span><br><span class="line">    managed_disk_type &#x3D; &quot;Premium_LRS&quot; # 磁盘的性能，也是查表获取的内容，关键字直接查询即可，而且你还会看到不同的价格表</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  storage_image_reference &#123; # 操作系统的引用说明，它目前需要配合plan来说明</span><br><span class="line">    publisher &#x3D; var.os_publisher # Flatcar的发布者</span><br><span class="line">    offer     &#x3D; var.os_offer # Flatcar的提供方</span><br><span class="line">    sku       &#x3D; var.os_sku # 版本属性，如stable，next等</span><br><span class="line">    version   &#x3D; var.os_version # 版本导航，如latest或者2516.2等</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  plan &#123; # 目前，我们配合前文storage_image_reference来说明计划，配置内容和前面一样，否则会报错</span><br><span class="line">    name      &#x3D; var.os_sku</span><br><span class="line">    publisher &#x3D; var.os_publisher</span><br><span class="line">    product   &#x3D; var.os_offer</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  storage_data_disk &#123; # 挂载外部磁盘</span><br><span class="line">  	# 引用了本地模块hibroDisk的属性，如名字和ID，还有后文的磁盘大小</span><br><span class="line">    name            &#x3D; module.hibroDisk.disk_touchMeStorage_name</span><br><span class="line">    managed_disk_id &#x3D; module.hibroDisk.disk_touchMeStorage_id</span><br><span class="line">    create_option   &#x3D; &quot;Attach&quot; # 挂接</span><br><span class="line">    lun             &#x3D; 0 # 磁盘在VM中的唯一编号</span><br><span class="line">    disk_size_gb    &#x3D; module.hibroDisk.disk_touchMeStorage_size</span><br><span class="line">    caching         &#x3D; &quot;ReadOnly&quot; # 磁盘的缓存属性为只读，但不是磁盘只读，说明缓存不能被动态写入而已</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  storage_data_disk &#123;</span><br><span class="line">    name            &#x3D; module.hibroDisk.disk_hitMeStorage_name</span><br><span class="line">    managed_disk_id &#x3D; module.hibroDisk.disk_hitMeStorage_id</span><br><span class="line">    create_option   &#x3D; &quot;Attach&quot;</span><br><span class="line">    lun             &#x3D; 1 # 磁盘在VM中的唯一编号</span><br><span class="line">    disk_size_gb    &#x3D; module.hibroDisk.disk_hitMeStorage_size</span><br><span class="line">    caching         &#x3D; &quot;ReadWrite&quot; # 另一种缓存属性，它说明可以支持动态修改缓存，不过对于系统来说只有操作系统视图有用</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  os_profile &#123; # 操作系统的规划配置</span><br><span class="line">    computer_name  &#x3D; &quot;hibro-VM&quot; # 主机名</span><br><span class="line">    admin_username &#x3D; var.admin_username # 有管理权限的用户名</span><br><span class="line">    # admin_password &#x3D; var.admin_password # (login with ssh public key) # 定义密码</span><br><span class="line">    # 配置文件渲染后的输出，这里需要重点说明下</span><br><span class="line">    # 这里引用了后文的配置文件对象，并且它会把渲染后的文件放到VM中的指定位置：&#x2F;var&#x2F;lib&#x2F;waagent&#x2F;CustomData</span><br><span class="line">    # 这里有一个[0],说明资源hibro_config是有count属性的，索引从0开始</span><br><span class="line">    custom_data    &#x3D; data.template_file.hibro_config[0].rendered</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  os_profile_linux_config &#123; # 这是类似的扩展配置内容，看起来是后续加的，不过我们只关心内容就可以</span><br><span class="line">    # disable_password_authentication &#x3D; false # (login with ssh public key) # 如果配置密码，那后面的内容就需要注释掉</span><br><span class="line">    disable_password_authentication &#x3D; true # 不使用密码，由于flatcar的特殊性，请使用SSH Key来登陆管理用户</span><br><span class="line">    ssh_keys &#123; </span><br><span class="line">      # 配置VM中存储你要传入的SSH pub key的地方</span><br><span class="line">      path     &#x3D; &quot;&#x2F;home&#x2F;$&#123;var.admin_username&#125;&#x2F;.ssh&#x2F;authorized_keys&quot;</span><br><span class="line">      # 你传入的SSH pub key值，用对应的私钥解密，对么？</span><br><span class="line">      key_data &#x3D; var.admin_pub_key</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  tags &#x3D; var.tags # 直接应用map类型变量的例子</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"># terraform官方提供的渲染文件的模板关键字&#96;template_file&#96;</span><br><span class="line">data &quot;template_file&quot; &quot;hibro_config&quot; &#123;</span><br><span class="line">  count &#x3D; 1 # 定义了一个count属性，后续医用资源的时候从0开始</span><br><span class="line">  # 模板文件的位置，file是terraform内置的函数获得文件，&#96;path.module&#96;为内置的变量，指定当前模块的目录位置</span><br><span class="line">  template &#x3D; file(&quot;$&#123;path.module&#125;&#x2F;configs&#x2F;hibro-azure.tmpl.yml&quot;)</span><br><span class="line"></span><br><span class="line">  vars &#x3D; &#123; # 渲染文件中的变量替换，好奇么？看看&#96;configs&#x2F;hibro-azure.tmpl.yml&#96;文件你就明白了</span><br><span class="line">    hibro_vm_ip_address &#x3D;  module.hibroRemote.public_ip_address</span><br><span class="line">    others_environment  &#x3D; &quot;hibro hacker&quot;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"># 这依旧是terraform定义的一个内置资源类型，它和其他的资源一样，只不过没有实体对应，就进行一些操作而已。</span><br><span class="line"># 这里通过这个资源来对已经启动的VM进行一些操作</span><br><span class="line">resource &quot;null_resource&quot; &quot;hibro_config_update&quot; &#123;</span><br><span class="line"></span><br><span class="line">  triggers &#x3D; &#123;</span><br><span class="line">  	# 定义一个触发资源更新的条件，这是对于&#96;terraform状态文件&#96;使用的而言的，如果文件更新了，资源才会再次操作</span><br><span class="line">    template_rendered &#x3D; data.template_file.hibro_config[0].rendered</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  connection &#123; # 定义连接到虚拟机的方式</span><br><span class="line">    type &#x3D; &quot;ssh&quot; # 通过该ssh协议</span><br><span class="line">    user &#x3D; &quot;core&quot; # 用户名，这里之所以没有写变量是因为提醒用户，对于Flatcar而言core通常就是默认的用户</span><br><span class="line">    # Azure CloudShell Must use Public IP Address to access the VM.</span><br><span class="line">    # 这里比较有意思，后面会详细的说明，这里你只需要知道是对一个远程模块定义的Public IP的引用即可</span><br><span class="line">    host &#x3D; module.hibroRemote.public_ip_address</span><br><span class="line">    # Azure CloudShell SSH Private Key location!</span><br><span class="line">    # Azure CloudShell的私钥存放位置，对应的肯定是公钥</span><br><span class="line">    private_key &#x3D; file(&quot;~&#x2F;.ssh&#x2F;id_rsa&quot;)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  provisioner &quot;file&quot; &#123; # 就是说明要干什么，file表示创建一个文件</span><br><span class="line">    # 内容是前文的渲染后版本</span><br><span class="line">    content     &#x3D; data.template_file.hibro_config[0].rendered</span><br><span class="line">    # 文件的写入位置和文件名称</span><br><span class="line">    destination &#x3D; &quot;&#x2F;tmp&#x2F;hibro-update&quot;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  provisioner &quot;remote-exec&quot; &#123; # remote-exec 说明要执行一些指令，就是你认为的常见的linux指令</span><br><span class="line">    inline &#x3D; [ # 指定的指令集合，以列表的形式说明</span><br><span class="line">      &quot;whoami &amp;&amp; ls &#x2F;tmp&#x2F; -l&quot;</span><br><span class="line">    ]</span><br><span class="line">  &#125;</span><br><span class="line">  # 需要虚拟机已经创建好才能进行操作，不是么？</span><br><span class="line">  depends_on &#x3D; [azurerm_virtual_machine.vm]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>此项目的所有资源都是统一前缀为<code>hibro-</code>，这只是一个自定义设计而已，但对于隔绝其他的命名空间，简单且有效。</p>
<p>模块在引用时，都会带着命名空间前缀<code>module</code>，类似<code>module.xxx.xxx</code>。</p>
<p>资源的创建有一定的依赖关系，terraform可以自行推导显示指定的依赖关系，不过如果没有显示指定的资源又产生了依赖，那么在并行创建的时候就会出现问题，所以有时候我们需要使用<code>depends_on</code>字段来说明资源的依赖关系。</p>
<p>拥有<code>count</code>属性的资源，是允许用户创建多个类似资源的快捷方式，引用的时候需要一些额外技巧，通过<code>[0]</code>的方式来引用，count定义的时候是从1开始，而引用的时候从0开始。</p>
<p>Terraform内置的函数和变量需要参考官方的技术手册，<a target="_blank" rel="noopener" href="https://www.terraform.io/docs/configuration/functions.html">走你</a> 。</p>
<p>需要知道的是，Azure CloudShell也是Azure给你提供的一个ubuntu虚拟机的bash shell伪终端而已，它也依附于一个系统之上，并没有多么神秘。</p>
<p>配置中有一项<code>host = module.hibroRemote.public_ip_address</code>要说明下，默认情况下Azure Cloudshell访问Azure自建虚拟机是有限制的，首先如果你的Azure Cloudshell没有和自建虚拟机在同一个网段，那么他们不能彼此访问，如果需要通过Azure CloudShell访问虚拟机，那就需要VM有一个挂接的公网IP，之后通过公网IP就可以通讯，当然Azure也提供了将Azure Cloud Shell并入你公司内网的方案，请自行查看官方文档以寻求帮助。</p>
<p>还有一点请注意，在Azure虚拟机中想要通过指令<code>ping</code>来测试连通性，比如从Azure VM到Azure CloudShell ubuntu是不行的，Azure官方有对ICMP协议的限制。</p>
<h3 id="output-tf（顶层输出）"><a href="#output-tf（顶层输出）" class="headerlink" title="output.tf（顶层输出）"></a>output.tf（顶层输出）</h3><p>对于顶层模块的输出，你可以灵活的进行配置，各种资源的输出你都可以尝试，我们的Demo只提供了一个条欢迎信息和一个有用的自动构建的虚拟机公网IP地址，如果你要使用当前登录，只需要知道公钥/私钥如何匹配，然后运行：<code>ssh core@&lt;vm_public_ip&gt;</code>即可完成登录。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"># Top-Level Output</span><br><span class="line">output &quot;Hi_Bro_From_Author&quot; &#123;</span><br><span class="line">	value &#x3D; &quot;Nice to meet you, any question, file to &lt; prexer.163.com &gt; | .. ^_^ .. &quot;</span><br><span class="line">&#125;</span><br><span class="line">output &quot;hibro_vm_public_ip&quot; &#123;</span><br><span class="line">	value &#x3D; module.hibroRemote.public_ip_address</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>





<h2 id="子模块的讲解部分"><a href="#子模块的讲解部分" class="headerlink" title="子模块的讲解部分"></a>子模块的讲解部分</h2><p>后文是对于子模块的讲解部分，每个模块内容比较少，所以我们把一个模块作为一个整体来阐述细节。</p>
<h3 id="moduleDisk"><a href="#moduleDisk" class="headerlink" title="moduleDisk"></a>moduleDisk</h3><p>模块的内容如下，我们依旧通过注释详解的方式来讲述案例</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><span class="line"># variable.tf</span><br><span class="line"># 这里承接顶层模块的参数传递，如果不传入，就会报错！</span><br><span class="line">variable &quot;prefix&quot; &#123;</span><br><span class="line">    type &#x3D; string</span><br><span class="line">&#125;</span><br><span class="line">variable &quot;location&quot; &#123;</span><br><span class="line">    type &#x3D; string</span><br><span class="line">&#125;</span><br><span class="line">variable &quot;resource_group&quot; &#123;</span><br><span class="line">    type &#x3D; string</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"># main.tf</span><br><span class="line"># 定义一个磁盘资源</span><br><span class="line">resource &quot;azurerm_managed_disk&quot; &quot;touchMeStorage&quot; &#123;</span><br><span class="line">  name                 &#x3D; &quot;$&#123;var.prefix&#125;-touchMe-storage&quot; # 磁盘资源的名字</span><br><span class="line">  location             &#x3D; var.location</span><br><span class="line">  resource_group_name  &#x3D; var.resource_group</span><br><span class="line">  storage_account_type &#x3D; &quot;Premium_LRS&quot; # 磁盘的性能指标，查看Azure官网就可以了</span><br><span class="line">  create_option        &#x3D; &quot;Copy&quot; # 这里说明从其他磁盘拷贝一个完整的镜像到自己身上</span><br><span class="line">  # 只有当&#96;create_option&#96;为&#96;Copy&#96;的时候才会有这个属性，它说明从哪里拷贝数据</span><br><span class="line">  source_resource_id   &#x3D; azurerm_managed_disk.copyMeStorage.id</span><br><span class="line">  disk_size_gb         &#x3D; &quot;8&quot; # 磁盘的大小，单位我就不用细说了吧...</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">resource &quot;azurerm_managed_disk&quot; &quot;hitMeStorage&quot; &#123;</span><br><span class="line">  #count               &#x3D; 1 # 磁盘可以有多个分身，不是么？批量的话，可以试试count属性</span><br><span class="line">  name                 &#x3D; &quot;$&#123;var.prefix&#125;-hitMe-Storage&quot;</span><br><span class="line">  location             &#x3D; var.location</span><br><span class="line">  resource_group_name  &#x3D; var.resource_group</span><br><span class="line">  storage_account_type &#x3D; &quot;StandardSSD_LRS&quot;</span><br><span class="line">  create_option        &#x3D; &quot;Empty&quot; # 这个属性说明磁盘建立的时候是空的，也说明它的建立非常快速，不是么？</span><br><span class="line">  disk_size_gb         &#x3D; &quot;8&quot;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"># no use, just to be copied, don&#39;t export out.</span><br><span class="line"># 这里也有注释说明，这个磁盘资源并没有被使用，而是作为一个替身，被别人复制了！其他的并没有什么特殊</span><br><span class="line">resource &quot;azurerm_managed_disk&quot; &quot;copyMeStorage&quot; &#123;</span><br><span class="line">  name                 &#x3D; &quot;$&#123;var.prefix&#125;-copyMe-Storage&quot;</span><br><span class="line">  location             &#x3D; var.location</span><br><span class="line">  resource_group_name  &#x3D; var.resource_group</span><br><span class="line">  storage_account_type &#x3D; &quot;Premium_LRS&quot;</span><br><span class="line">  create_option        &#x3D; &quot;Empty&quot;</span><br><span class="line">  disk_size_gb         &#x3D; &quot;8&quot;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"># output.tf</span><br><span class="line"># 这部分是该子模块的输出，而顶层模块也只能引用它的输出部分，并不能看见它的内部结构。</span><br><span class="line"># 引用的时候应该类似：module.&lt;alias_name&gt;.disk_touchMeStorage_name</span><br><span class="line">output &quot;disk_touchMeStorage_name&quot; &#123;</span><br><span class="line">    value &#x3D; azurerm_managed_disk.touchMeStorage.name</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">output &quot;disk_touchMeStorage_id&quot; &#123;</span><br><span class="line">    value &#x3D; azurerm_managed_disk.touchMeStorage.id</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">output &quot;disk_touchMeStorage_size&quot;&#123;</span><br><span class="line">    value &#x3D; azurerm_managed_disk.touchMeStorage.disk_size_gb</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">output &quot;disk_hitMeStorage_name&quot; &#123;</span><br><span class="line">    value &#x3D; azurerm_managed_disk.hitMeStorage.name</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">output &quot;disk_hitMeStorage_id&quot; &#123;</span><br><span class="line">    value &#x3D; azurerm_managed_disk.hitMeStorage.id</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">output &quot;disk_hitMeStorage_size&quot;&#123;</span><br><span class="line">    value &#x3D; azurerm_managed_disk.hitMeStorage.disk_size_gb</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="moduleNet"><a href="#moduleNet" class="headerlink" title="moduleNet"></a>moduleNet</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"># variable.tf</span><br><span class="line"># 必要的传入参数，你懂的</span><br><span class="line">variable &quot;prefix&quot; &#123;</span><br><span class="line">    type &#x3D; string</span><br><span class="line">&#125;</span><br><span class="line">variable &quot;location&quot; &#123;</span><br><span class="line">    type &#x3D; string</span><br><span class="line">&#125;</span><br><span class="line">variable &quot;resource_group&quot; &#123;</span><br><span class="line">    type &#x3D; string</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"># main.tf</span><br><span class="line"># 网络资源部分的讲解在本文不会涉猎太多，因为如果要说明它，可能要一本书才能完成，请自行查阅资料。</span><br><span class="line"># 当然必要的简单描述还是有必要的！</span><br><span class="line"># Create virtual network</span><br><span class="line"># 定义一个虚拟网络，网络拓扑应该是这样的关系</span><br><span class="line"># vnet -&gt; subnet(with mask) -&gt; private ip</span><br><span class="line">resource &quot;azurerm_virtual_network&quot; &quot;vnet&quot; &#123; </span><br><span class="line">  name                &#x3D; &quot;$&#123;var.prefix&#125;-Vnet&quot;</span><br><span class="line">  address_space       &#x3D; [&quot;10.0.0.0&#x2F;16&quot;] # 虚拟网络的网段定义</span><br><span class="line">  location            &#x3D; var.location # 这里强调下网络的配置，之前提到过跨域的资源访问，网络资源是绝对不能跨地域来访问的，不然要VPN干嘛？</span><br><span class="line">  resource_group_name &#x3D; var.resource_group</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"># Create subnet</span><br><span class="line"># 定义一个子网网段</span><br><span class="line">resource &quot;azurerm_subnet&quot; &quot;subnet&quot; &#123;</span><br><span class="line">  name                 &#x3D; &quot;$&#123;var.prefix&#125;-Subnet&quot;</span><br><span class="line">  resource_group_name  &#x3D; var.resource_group</span><br><span class="line">  virtual_network_name &#x3D; azurerm_virtual_network.vnet.name # 所属的虚拟网络，正好是我们前面创建额</span><br><span class="line">  address_prefixes     &#x3D; [&quot;10.0.1.0&#x2F;24&quot;] # 子网网段，&#96;10.0.1.0&#96;是符合私用标准的范围，免费内网使用</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"># Create Network Security Group and rule</span><br><span class="line"># 定义一个网络安全组，它其实是说明为了网络安全，哪些端口，或者协议可以开放，进行更细粒度的限制</span><br><span class="line">resource &quot;azurerm_network_security_group&quot; &quot;nsg&quot; &#123;</span><br><span class="line">  name                &#x3D; &quot;$&#123;var.prefix&#125;-NSG&quot;</span><br><span class="line">  location            &#x3D; var.location</span><br><span class="line">  resource_group_name &#x3D; var.resource_group</span><br><span class="line"></span><br><span class="line">  security_rule &#123; # 定义一个安全规则</span><br><span class="line">    name                       &#x3D; &quot;SSH&quot; # 开通SSH协议</span><br><span class="line">    priority                   &#x3D; 1001 # 优先级，当不同协议被定义的时候，数据被截获的顺序和优先级有关</span><br><span class="line">    direction                  &#x3D; &quot;Inbound&quot; # 输入方向</span><br><span class="line">    access                     &#x3D; &quot;Allow&quot;</span><br><span class="line">    protocol                   &#x3D; &quot;Tcp&quot; # 传输层协议</span><br><span class="line">    source_port_range          &#x3D; &quot;*&quot; # 所有地址都可以访问</span><br><span class="line">    destination_port_range     &#x3D; &quot;22&quot; # SSH标准端口</span><br><span class="line">    source_address_prefix      &#x3D; &quot;*&quot; # 没有地址前缀限制</span><br><span class="line">    destination_address_prefix &#x3D; &quot;*&quot; # 目标地址也没哟前缀限制</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"># output.tf</span><br><span class="line"># 这是网络模块的输出部分，它对外给虚拟机的网卡输出一个&#96;SUBNET ID&#96;，来让网卡可以挂到我们创建的子网上面。</span><br><span class="line">output &quot;subnet_id&quot; &#123;</span><br><span class="line">    value &#x3D; azurerm_subnet.subnet.id</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<h3 id="moduleRemote"><a href="#moduleRemote" class="headerlink" title="moduleRemote"></a>moduleRemote</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"># variable.tf</span><br><span class="line">variable &quot;prefix&quot; &#123;</span><br><span class="line">    type &#x3D; string</span><br><span class="line">&#125;</span><br><span class="line">variable &quot;location&quot; &#123;</span><br><span class="line">    type &#x3D; string</span><br><span class="line">&#125;</span><br><span class="line">variable &quot;resource_group&quot; &#123;</span><br><span class="line">    type &#x3D; string</span><br><span class="line">&#125;</span><br><span class="line"># 由于这个模块我们要绑定网卡到子网上，所以需要传入外部已经定义好的子网ID</span><br><span class="line">variable &quot;subnet_id&quot; &#123;</span><br><span class="line">    type &#x3D; string</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"># main.tf</span><br><span class="line"># Create public IP</span><br><span class="line"># 申请一个public ip资源</span><br><span class="line">resource &quot;azurerm_public_ip&quot; &quot;publicip&quot; &#123;</span><br><span class="line">  name                &#x3D; &quot;$&#123;var.prefix&#125;-PublicIP&quot;</span><br><span class="line">  location            &#x3D; var.location</span><br><span class="line">  resource_group_name &#x3D; var.resource_group</span><br><span class="line">  allocation_method   &#x3D; &quot;Static&quot; # 分配一个静态IP地址，只有两种类型&#96;dynamic&#96;和&#96;static&#96;</span><br><span class="line">&#125;</span><br><span class="line"># 当外部想要引用资源的未导出数据时，需要定义一个同名的data资源块，然后完成引用</span><br><span class="line"># 需要知道，有些资源的数据在没有导出的时候是不能引用的，也就是你看不见，这种方法也是官方推荐的！</span><br><span class="line"># 你需要的只是定义一个同名块，然后填写必要的数据即可。</span><br><span class="line">data &quot;azurerm_public_ip&quot; &quot;publicip&quot; &#123;</span><br><span class="line">  name                &#x3D; azurerm_public_ip.publicip.name</span><br><span class="line">  resource_group_name &#x3D; azurerm_public_ip.publicip.resource_group_name</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"># Create network interface</span><br><span class="line"># 定义一个网卡</span><br><span class="line">resource &quot;azurerm_network_interface&quot; &quot;nic&quot; &#123;</span><br><span class="line">  name                      &#x3D; &quot;$&#123;var.prefix&#125;-NIC&quot;</span><br><span class="line">  location                  &#x3D; var.location</span><br><span class="line">  resource_group_name       &#x3D; var.resource_group</span><br><span class="line"></span><br><span class="line">  ip_configuration &#123; # 网卡配置参数</span><br><span class="line">    name                          &#x3D; &quot;$&#123;var.prefix&#125;-NIC-Confg&quot;</span><br><span class="line">    subnet_id                     &#x3D; var.subnet_id # 所属子网</span><br><span class="line">    private_ip_address_allocation &#x3D; &quot;dynamic&quot; # 在子网中，被分配IP的类型，这里是动态的</span><br><span class="line">    public_ip_address_id          &#x3D; azurerm_public_ip.publicip.id # 关联的公网IP，也就是前文创建的Public IP资源</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"># output.tf</span><br><span class="line"># 为顶层模块的虚拟机提供网卡支持，输出ID即可</span><br><span class="line">output &quot;nic_id&quot; &#123;</span><br><span class="line">    value &#x3D; azurerm_network_interface.nic.id</span><br><span class="line">&#125;</span><br><span class="line"># 为顶层模块提供自动构建的公网IP，用于顶层模块的输出显示！</span><br><span class="line">output &quot;public_ip_address&quot; &#123;</span><br><span class="line">    value &#x3D; data.azurerm_public_ip.publicip.ip_address</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h2 id="有好的建议和想法？联系我吧"><a href="#有好的建议和想法？联系我吧" class="headerlink" title="有好的建议和想法？联系我吧"></a>有好的建议和想法？联系我吧</h2><p>本项目的官方文档会持续更新，如果有什么建议可以直接邮件给作者<code>prexer@163.com</code>。</p>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="mailto:undefined">prexer</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="http://example.com/2020/11/03/terraform-azure-demo-doc/">http://example.com/2020/11/03/terraform-azure-demo-doc/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="http://example.com" target="_blank">妖灵山</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/azure/">azure</a><a class="post-meta__tags" href="/tags/terraform/">terraform</a><a class="post-meta__tags" href="/tags/cloud/">cloud</a></div><div class="post_share"><div class="social-share" data-image="/images/blog-images/terraform_logo.png" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/social-share.js/dist/css/share.min.css"><script src="https://cdn.jsdelivr.net/npm/social-share.js/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><div class="next-post pull-full"><a href="/2020/10/30/ca-certificate-authentication-md/"><img class="next-cover" src="/images/blog-images/ca_logo.png" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">你想通过本地构建CA来颁发证书么？</div></div></a></div></nav><hr/><div id="post-comment"><div class="comment-head"><div class="comment-headline"><i class="fas fa-comments fa-fw"></i><span> 评论</span></div></div><div class="comment-wrap"><div><div class="vcomment" id="vcomment"></div></div></div></div></div><div class="aside_content" id="aside_content"><div class="card-widget card-info"><div class="card-content"><div class="card-info-avatar is-center"><img class="avatar-img" src="/images/site/header.jpg" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/><div class="author-info__name">prexer</div><div class="author-info__description">Email-To-Me: prexer@163.com</div></div><div class="card-info-data"><div class="card-info-data-item is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">5</div></a></div><div class="card-info-data-item is-center"><a href="/tags/"><div class="headline">标签</div><div class="length-num">15</div></a></div><div class="card-info-data-item is-center"><a href="/categories/"><div class="headline">分类</div><div class="length-num">7</div></a></div></div><a class="button--animated" id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/prexerx"><i class="fab fa-github"></i><span>Follow Me</span></a><div class="card-info-social-icons is-center"><a class="social-icon" href="https://gitee.com/prexer" target="_blank" title="Gitee"><i class="fab fa-git-square"></i></a><a class="social-icon" href="https://github.com/prexerx" target="_blank" title="Github"><i class="fab fa-github"></i></a><a class="social-icon" href="mailto:prexer@163.com" target="_blank" title="Email"><i class="fas fa-envelope"></i></a></div></div></div><div class="card-widget card-announcement"><div class="card-content"><div class="item-headline"><i class="fas fa-bullhorn card-announcement-animation"></i><span>公告</span></div><div class="announcement_content">欢迎来到`妖灵山`读文章，如果我们能帮到你，那确实是一件令人开心的事！</div></div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="card-content"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%A1%B9%E7%9B%AE%E7%AE%80%E4%BB%8B"><span class="toc-number">1.</span> <span class="toc-text">项目简介</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%A1%B9%E7%9B%AE%E6%A6%82%E8%A7%88"><span class="toc-number">2.</span> <span class="toc-text">项目概览</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%BD%93%E5%89%8D%E5%A4%8D%E7%8E%B0%E7%8E%AF%E5%A2%83"><span class="toc-number">3.</span> <span class="toc-text">当前复现环境</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%BF%AB%E9%80%9F%E4%B8%8A%E6%89%8B%E5%B0%9D%E9%B2%9C"><span class="toc-number">4.</span> <span class="toc-text">快速上手尝鲜</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%BF%AB%E9%80%9F%E8%8E%B7%E5%8F%96%E6%8A%80%E6%9C%AF%E5%B8%AE%E5%8A%A9"><span class="toc-number">5.</span> <span class="toc-text">快速获取技术帮助</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%A1%B9%E7%9B%AE%E5%AE%9E%E7%8E%B0%E7%BB%86%E8%8A%82"><span class="toc-number">6.</span> <span class="toc-text">项目实现细节</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#backend-tf"><span class="toc-number">6.1.</span> <span class="toc-text">backend.tf</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#default-auto-tfvars"><span class="toc-number">6.2.</span> <span class="toc-text">default.auto.tfvars</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#variable-tf%EF%BC%88%E9%A1%B6%E5%B1%82%E8%BE%93%E5%85%A5%EF%BC%89"><span class="toc-number">6.3.</span> <span class="toc-text">variable.tf（顶层输入）</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#main-tf-%E9%A1%B6%E5%B1%82%E4%B8%BB%E8%A6%81%E9%85%8D%E7%BD%AE"><span class="toc-number">6.4.</span> <span class="toc-text">main.tf(顶层主要配置)</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#output-tf%EF%BC%88%E9%A1%B6%E5%B1%82%E8%BE%93%E5%87%BA%EF%BC%89"><span class="toc-number">6.5.</span> <span class="toc-text">output.tf（顶层输出）</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AD%90%E6%A8%A1%E5%9D%97%E7%9A%84%E8%AE%B2%E8%A7%A3%E9%83%A8%E5%88%86"><span class="toc-number">7.</span> <span class="toc-text">子模块的讲解部分</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#moduleDisk"><span class="toc-number">7.1.</span> <span class="toc-text">moduleDisk</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#moduleNet"><span class="toc-number">7.2.</span> <span class="toc-text">moduleNet</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#moduleRemote"><span class="toc-number">7.3.</span> <span class="toc-text">moduleRemote</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%9C%89%E5%A5%BD%E7%9A%84%E5%BB%BA%E8%AE%AE%E5%92%8C%E6%83%B3%E6%B3%95%EF%BC%9F%E8%81%94%E7%B3%BB%E6%88%91%E5%90%A7"><span class="toc-number">8.</span> <span class="toc-text">有好的建议和想法？联系我吧</span></a></li></ol></div></div></div><div class="card-widget card-recent-post"><div class="card-content"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/2020/11/03/terraform-azure-demo-doc/" title="Terraform Azure Demo开源项目的官方文档"><img src="/images/blog-images/terraform_logo.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Terraform Azure Demo开源项目的官方文档"/></a><div class="content"><a class="title" href="/2020/11/03/terraform-azure-demo-doc/" title="Terraform Azure Demo开源项目的官方文档">Terraform Azure Demo开源项目的官方文档</a><time datetime="2020-11-03T01:45:37.000Z" title="发表于 2020-11-03 01:45:37">2020-11-03</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2020/10/30/ca-certificate-authentication-md/" title="你想通过本地构建CA来颁发证书么？"><img src="/images/blog-images/ca_logo.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="你想通过本地构建CA来颁发证书么？"/></a><div class="content"><a class="title" href="/2020/10/30/ca-certificate-authentication-md/" title="你想通过本地构建CA来颁发证书么？">你想通过本地构建CA来颁发证书么？</a><time datetime="2020-10-30T09:01:12.000Z" title="发表于 2020-10-30 09:01:12">2020-10-30</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2020/10/29/docker/internal_dns_server_setup/" title="在内网快速利用docker搭建DNS服务器"><img src="/images/blog-images/dns_setup.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="在内网快速利用docker搭建DNS服务器"/></a><div class="content"><a class="title" href="/2020/10/29/docker/internal_dns_server_setup/" title="在内网快速利用docker搭建DNS服务器">在内网快速利用docker搭建DNS服务器</a><time datetime="2020-10-29T07:05:35.000Z" title="发表于 2020-10-29 07:05:35">2020-10-29</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2020/10/24/base/git_speed_up_downloading/" title="推荐一个加速git仓库下载的方法"><img src="/images/site/dead-cells-04.jpeg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="推荐一个加速git仓库下载的方法"/></a><div class="content"><a class="title" href="/2020/10/24/base/git_speed_up_downloading/" title="推荐一个加速git仓库下载的方法">推荐一个加速git仓库下载的方法</a><time datetime="2020-10-24T04:42:57.000Z" title="发表于 2020-10-24 04:42:57">2020-10-24</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2020/02/20/articles_writing_rules/" title="文章编写规范"><img src="/images/site/dead-cells-03.jpeg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="文章编写规范"/></a><div class="content"><a class="title" href="/2020/02/20/articles_writing_rules/" title="文章编写规范">文章编写规范</a><time datetime="2020-02-20T20:02:20.000Z" title="发表于 2020-02-20 20:02:20">2020-02-20</time></div></div></div></div></div></div></div></main><footer id="footer" style="background-image: url(/images/site/index_home_top.jpg)"><div id="footer-wrap"><div class="copyright">&copy;2020 By prexer</div><div class="framework-info"><span>框架 </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>主题 </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="设置"><i class="fas fa-cog"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><a id="to_comment" href="#post-comment" title="直达评论"><i class="fas fa-comments"></i></a><button id="go-up" type="button" title="回到顶部"><i class="fas fa-arrow-up"></i></button></div></div><div id="local-search"><div class="search-dialog"><div class="search-dialog__title" id="local-search-title">本地搜索</div><div id="local-input-panel"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="搜索文章" type="text"/></div></div></div><hr/><div id="local-search-results"></div><span class="search-close-button"><i class="fas fa-times"></i></span></div><div id="search-mask"></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="https://cdn.jsdelivr.net/npm/node-snackbar/dist/snackbar.min.js"></script><script src="/js/search/local-search.js"></script><script>var preloader = {
  endLoading: () => {
    document.body.style.overflow = 'auto';
    document.getElementById('loading-box').classList.add("loaded")
  },
  initLoading: () => {
    document.body.style.overflow = '';
    document.getElementById('loading-box').classList.remove("loaded")

  }
}
window.addEventListener('load',()=> {preloader.endLoading()})</script><div class="js-pjax"><script>function loadValine () {
  function initValine () {
    let initData = {
      el: '#vcomment',
      appId: 'qsamq3Y5DtW17GTEo8fUTR1q-gzGzoHsz',
      appKey: 'U3LxIC5Qmh7XJxc7oi8JWoJ2',
      placeholder: '评论之前，请带上你的灵魂，谈论和本文有关的内容，如果是闲聊或者吐槽，请到留言板...',
      avatar: 'monsterid',
      meta: 'nick,mail,link'.split(','),
      pageSize: '10',
      lang: 'zh-CN',
      recordIP: false,
      serverURLs: 'https://qsamq3y5.lc-cn-n1-shared.com',
      emojiCDN: '',
      emojiMaps: "",
      enableQQ: false,
      path: window.location.pathname,
    }

    if (true) { 
      initData.requiredFields= ('nick,mail'.split(','))
    }
    
    if (false) {
      const otherData = false
      initData = Object.assign({}, initData, otherData)
    }
    
    const valine = new Valine(initData)
  }

  if (typeof Valine === 'function') initValine() 
  else getScript('https://cdn.jsdelivr.net/npm/valine/dist/Valine.min.js').then(initValine)
}

if ('Valine' === 'Valine' || !true) {
  if (true) btf.loadComment(document.querySelector('#vcomment'),loadValine)
  else setTimeout(() => loadValine(), 0)
} else {
  function loadOtherComment () {
    loadValine()
  }
}</script><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div><script defer="defer" id="ribbon" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/dist/canvas-ribbon.min.js" size="150" alpha="0.6" zIndex="-1" mobile="false" data-click="false"></script></div></body></html>